<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Map interactive — fenêtres de contenu</title>
<style>
  :root{
    --ui-bg: rgba(0,0,0,0.6);
    --ui-color: #fff;
    --player-size: 50px;
    --marker-size: 0px;
  }
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;}
  #app{height:100vh;display:flex;flex-direction:column;}
  #hud{
    position:fixed; left:10px; top:10px; z-index:30;
    background:var(--ui-bg); color:var(--ui-color); padding:8px 12px;border-radius:8px;
    font-size:14px; box-shadow:0 4px 12px rgba(0,0,0,.4);
    user-select:none;
  }
  #hud b{display:inline-block; min-width:80px;}
  #viewport{
    position:relative; flex:1; overflow:hidden; background:#222;
  }
  #map{
    position:absolute; left:0; top:0;
    transform-origin:0 0;
  }
  #player{
    position:absolute;
    width:var(--player-size); height:var(--player-size);
    margin-left: calc(var(--player-size) / -2);
    margin-top: calc(var(--player-size) / -2);
    z-index:40;
    cursor:grab;
    transition: transform .03s linear;
  }
  #player:active{cursor:grabbing;}
  .marker{
    position:absolute;
    width:var(--marker-size); height:var(--marker-size);
    margin-left: calc(var(--marker-size) / -2);
    margin-top: calc(var(--marker-size) / -2);
    z-index:35;
    pointer-events:auto;
    user-select:none;
  }
  /* ==================== MODALE ==================== */
  #modal{
    display:none; position:fixed; inset:0; z-index:100; 
    background: rgba(0,0,0,.7);
    align-items:center; justify-content:center;
    padding:20px;
  }
  #modalContent{
    background:#fff; color:#000;
    max-width:600px; max-height:80vh;
    overflow-y:auto;
    border-radius:10px;
    padding:20px;
    box-shadow:0 10px 40px rgba(0,0,0,.5);
    text-align:center;
  }
  #modalContent img{
    max-width:100%;
    height:auto;
    border-radius:8px;
    margin-bottom:12px;
  }
  #closeBtn{
    background:#222; color:#fff;
    border:none;
    padding:8px 16px;
    border-radius:6px;
    cursor:pointer;
    margin-top:10px;
  }
  #tips{
    position:fixed; right:10px; top:10px; z-index:30;
    background:var(--ui-bg); color:var(--ui-color); padding:8px 12px;border-radius:8px;
    font-size:13px; max-width:220px;
  }
  @media (max-width:600px){
    #hud {font-size:12px}
    :root{--player-size:28px; --marker-size:28px;}
  }
</style>
</head>
<body>
<div id="app">
  <div id="hud">
    <div><b>Position</b> <span id="pos">x:0, y:0</span></div>
    <div style="margin-top:6px"><b>Map</b> <span id="mapName"></span></div>
    <div style="margin-top:6px"><b>Lieu</b> <span id="locLabel"></span></div>
  </div>

  <div id="viewport">
    <div id="map">
      <img id="player" src="data:image/svg+xml;utf8,
        <svg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 24 24' fill='none' stroke='%23ffcc00' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='10' r='3.2' /><path d='M12 2v3M12 21v-3M20 12h-3M7 12H4M17.5 6.5L15.5 8.5M8.5 15.5L6.5 17.5M17.5 17.5L15.5 15.5M8.5 8.5L6.5 6.5' /></svg>" alt="player" draggable="false">
    </div>
  </div>

  <!-- Fenêtre modale -->
  <div id="modal">
    <div id="modalContent">
      <img id="modalImg" src="" alt="">
      <div id="modalText"></div>
      <button id="closeBtn" onclick="hideModal()">Fermer</button>
    </div>
  </div>
</div>

<script>
/* ==========================
   CONFIGURATION
   ========================== */
const MAPS = {
  "ville-centre": {
    id: "ville-centre",
    name: "Ville - Centre",
    bg: "Biblio/Noir.png",
    width: 1100,
    height: 600
  }
};

// Map de départ
let CURRENT_MAP_ID = "ville-centre";

/* Exemple : chaque lieu peut maintenant avoir :
   - type: 'info' → ouvrira une fenêtre dans la page
   - img: image à afficher
   - text: texte avec \n ou \n\n
*/
let LOCATIONS = [
  { x: 124, y: 500, img: "Philo/Bonheur.png", size: 80, type: "info", 
    label:"Bonheur",
    contentImg:"Philo/Bonheur2.png",
    contentText:"Adorno dans la dialectique de la raison introduit le terme d’industrie culturelle pour désigner la production de masse de biens culturels. Ce n’est pas une simple extension de la culture populaire : c’est une rationalisation capitaliste de la culture, soumise aux logiques de la production en série et du profit. La culture devient un système uniforme, planifié, qui impose partout les mêmes modèles et réduit la diversité au nom de l’efficacité économique  /n /n L’industrie culturelle fonctionne selon des schémas fixes : mêmes intrigues au cinéma, mêmes stéréotypes dans la musique, mêmes recettes dans la littérature de masse. Ce qui est présenté comme « nouveau » n’est en réalité qu’une variation d’un produit déjà connu. Cela garantit que rien d’imprévu ou de subversif ne puisse émerger. La nouveauté devient un slogan publicitaire, pas une réalité artistique /n /n La consommation de masse n’éveille plus l’imagination, elle la paralyse. Le spectateur doit suivre la succession rapide d’images et de sons sans pouvoir ajouter de sens personnel. Le loisir devient une extension du travail : on se « détend » pour mieux retourner à l’usine le lendemain. L’amusement n’est pas une libération mais une forme de résignation organisée : on consomme ce qui est proposé et on se contente de l’illusion de liberté /n /n Le produit culturel promet un plaisir qu’il ne délivre jamais réellement : il entretient un désir frustré (par exemple avec le cinéma érotique où tout est suggéré mais rien montré). La publicité devient le moteur de l’industrie culturelle, et le consommateur participe par peur de « manquer quelque chose ». Ce mécanisme prépare les masses à accepter des formes de manipulation politique, comme dans le fascisme",
      },
  { x: 170, y: 160, img: "Philo/Conscience.png", size: 80, type: "info", 
    label:"Conscience",
    contentImg:"Philo/Conscience2.png",
    contentText:"L'HOMME FACE A LUI MEME\nL’humanité a longtemps cru que toute la nature était animée par une conscience : des plantes aux étoiles, tout semblait habité. Avec la science et la technique, cette vision s’est effacée. L’homme a d’abord expulsé le divin de la nature, puis de son propre esprit, jusqu’à se retrouver seul face à sa conscience. Mais ce qu’il croyait être une transparence immédiate s’est révélé bien plus complexe et problématique.\nLa conscience est avant tout une présence à soi, une expérience immédiate. Elle ne requiert pas la réflexion : lorsqu’on a mal, on le sait sans raisonnement. C’est un rapport intérieur entre soi et ses représentations. Une représentation (souvenir, idée, rêve) est consciente lorsqu’elle est perçue comme telle. Le mot vient du latin cum (avec) et scire (savoir) : savoir avec soi-même. Locke en donne une définition claire : la conscience est la perception des événements de l’esprit. Elle n’est donc pas une substance, mais une modalité de l’activité psychique.\nJe connais mieux mes pensées ou mes émotions que les processus physiologiques de mon corps. Descartes en fit le fondement de la certitude philosophique. La conscience a cette spécificité d’être réflexive : elle peut se prendre elle-même pour objet. Lorsque je pense, je pense que je pense. Cela introduit une scission intérieure : le je (source d’activité) se distingue du moi (image ou forme qu’il prend). Ainsi, je peux me révolter à la fois contre le monde et contre le moi passif que j’étais. La conscience est toujours relation, mais relation qui suppose un écart entre soi et soi.\nDepuis l’âge classique, la question de l’évolution de la conscience oppose deux conceptions philosophiques majeures. Pour Spinoza, la conscience n’apparaît pas de façon graduelle mais selon une rupture nette : tant que l’esprit reste prisonnier de l’imagination, il se contente d’opinions et d’images floues, sans véritable accès à la vérité. Mais dès que l’homme atteint la connaissance adéquate – d’abord par la raison, puis par l’intuition intellectuelle –, la conscience se déploie d’un seul coup dans sa pleine lumière. C’est une logique du « tout ou rien » : ou bien l’on reste dans l’illusion, ou bien l’on accède à la vérité. Leibniz, au contraire, pense la conscience comme un phénomène progressif. Selon lui, il existe des degrés dans la clarté et la distinction des perceptions : certaines sont confuses et presque imperceptibles, d’autres plus nettes et articulées. Cette vision suppose que la conscience n’est pas un bloc homogène, mais un champ modulable où coexistent différents niveaux d’intensité. Ainsi, le débat entre Spinoza et Leibniz éclaire deux manières de comprendre l’esprit : soit comme un basculement radical, soit comme un continuum de lucidité croissante. \n \n L'HOMME ET L'AUTRE\nLe test du miroir, que certains singes réussissent, interroge : se reconnaître implique-t-il une véritable conscience de soi ? Reconnaître son reflet n’est pas seulement identifier une image, mais se rapporter à soi à travers une médiation symbolique. Chez l’enfant, ce moment fonde une conscience de soi encore fragile. Lacan y voit un « stade du miroir » : je m’identifie à une image qui n’est pas moi, ce qui révèle que l’identité suppose toujours une séparation entre le réel et l’imaginaire. Le miroir révèle une vérité fondamentale : dans la conscience, le sujet existe deux fois, comme sujet regardant et comme objet regardé. Il en est de même dans la mémoire : je me souviens de mon enfance, mais je suis à la fois celui qui se souvient et l’enfant dont je me souviens. La conscience repose donc sur une scission originaire, un écart constitutif entre l’être et son image.\nAvec Fichte, la conscience change de statut. Elle n’est plus définie seulement comme pensée, mais comme action. Le Moi n’existe que dans la mesure où il se pose face au Non-Moi, c’est-à-dire face à une réalité qui lui résiste. La conscience n’est pas contemplation mais activité : elle se constitue en se confrontant au monde. Sa fonction est alors d’être un acte fondateur, une force dynamique, plutôt qu’un simple reflet. Dans Mémoire sur la décomposition de la pensée, Maine de Biran radicalise cette idée. Pour lui, la conscience ne naît pas d’une pure activité intellectuelle, mais de l’expérience concrète de l’effort. Lorsqu’une volonté rencontre une résistance — par exemple, lorsqu’on soulève un objet lourd ou lorsqu’on lutte contre une habitude —, elle prend conscience de son existence. La fonction de la conscience est donc de nous donner une expérience intime du « moi » comme force en action. Sans cette résistance du monde, il n’y aurait ni conscience de soi ni véritable connaissance. La conscience est aussi déterminée par des dynamiques internes et relationnelles. Hegel illustre ce processus à travers la dialectique du Maître et de l’Esclave : la conscience se forme toujours dans une confrontation avec autrui. \n \n FRAGILE CONSCIENCE\nPendant longtemps, de Descartes à Freud, la conscience a été pensée comme une réalité substantielle. Elle était conçue comme une sorte de substrat stable, analogue à une scène de théâtre sur laquelle viennent se jouer des représentations successives sans que la scène elle-même ne soit modifiée. Cette conception permettait de penser l’identité personnelle dans le temps : malgré les changements, quelque chose demeure identique en nous. C’est ce fondement qui rend possible la responsabilité morale (récompense et châtiment), mais aussi la continuité de l’expérience. Descartes illustre cette perspective avec le cogito, qui pose la conscience comme un absolu, un point d’appui premier. Chez Kant, cette fonction fondatrice est reprise sous la forme de l’aperception transcendantale : la conscience de l’unité de soi est une condition nécessaire pour rendre cohérentes toutes nos représentations.\nSartre, de son côté, renverse la tradition cartésienne. Pour lui, la conscience irréfléchie (pré-réflexive) est plus fondamentale que la conscience réfléchie. La conscience n’est pas seulement connaissance mais existence, et elle se joue elle-même dans la mauvaise foi : elle peut se tromper sur elle-même, mais jamais totalement. Il existe un jeu entre soi et soi, mais ce jeu est limité.\nFace à cette tradition, une critique s’est développée : et si la conscience n’était pas première, mais seconde ? Freud, par exemple, montre que le moi conscient n’est qu’une « pauvre chose » (eine armes Ding), largement dépendante de processus inconscients. Nietzsche avait déjà ouvert la voie en dénonçant le cogito comme un préjugé philosophique : comment savoir que je pense, si je ne possède pas déjà une conception préalable de ce qu’est la pensée ? La certitude immédiate que Descartes revendique n’est pas donnée, mais présupposée.\nSelon Nietzsche, la conscience se développe par la mise en commun de nos idées« moyennes», comme une maladie contagieuse qui vulgarise nos intuitions et nous éloigne de nos meilleurs instincts. La conscience ne naît pas de l’individu isolé mais de la vie communautaire : elle est d’abord un outil de communication. Ce qui devient conscient est réduit en mots et en signes, donc appauvri : la conscience transforme le vécu singulier en représentations générales et superficielles. Ainsi, la conscience est à la fois une falsification du réel et un danger pour l’homme moderne, pouvant être vue comme une maladie.\nPour Marx, la conscience n’est pas première : elle est un produit social. « Ce n’est pas la conscience qui détermine l’être, mais l’être qui détermine la conscience ». Autrement dit, les conditions matérielles et sociales de la vie façonnent la manière dont nous pensons et nous représentons le monde. Chaque époque historique engendre ainsi une forme spécifique de conscience : chez les Grecs, la conscience de l’homme face au logos ; dans le christianisme, la conscience déchirée par la faute et la rédemption ; à l’époque moderne, la conscience individuelle, libre et responsable. Ces transformations montrent que la conscience n’est pas universelle et immuable, mais marquée par l’histoire et les contradictions sociales.\nDans cette perspective, elle est comprise comme une fonction exécutive supérieure, un produit dérivé d’autres conditions plus fondamentales. Elle n’est pas un phénomène originaire mais le résultat de déterminations multiples : physiques (organisation neurobiologique du cerveau), sociales (cadres culturels, langage, institutions), psychiques (désirs, pulsions, inconscient). La conscience, loin d’être absolue et auto-fondée, apparaît ainsi comme le sommet fragile et contingent d’un édifice plus vaste, qui la dépasse et la conditionne. \n \n CONSCIENCE IDENTITE\nWilliam James met en avant une fonction : la continuité de l’expérience. La conscience est pour lui un flux (stream of consciousness) où se mêlent ruptures et continuité. Elle nous permet de lier nos perceptions, nos souvenirs et nos pensées en une expérience vécue comme cohérente. Sa fonction est donc intégrative : elle relie entre elles des impressions fragmentées pour donner l’impression d’un moi stable.\nPour David Hume, philosophe sceptique du XVIIIᵉ siècle, l’idée d’un « moi » stable est une illusion. Lorsque nous observons notre esprit, nous ne percevons jamais une substance qui serait le « moi », mais uniquement des perceptions particulières : des sensations, des souvenirs, des désirs, des émotions. Ces perceptions s’enchaînent dans le temps comme les perles d’un collier, mais il n’existe pas de fil invisible qui les relierait. Ainsi, le moi permanent n’est pas une donnée immédiate de la conscience, mais une reconstruction, presque une habitude mentale, qui nous fait croire à une identité continue. Cette analyse conduit Hume à conclure que la conscience est fondamentalement fragmentée et incapable de saisir directement une essence personnelle.\nÀ l’opposé, Henri Bergson, au tournant du XIXᵉ et du XXᵉ siècle, insiste sur le caractère dynamique de la conscience. Pour lui, celle-ci est intimement liée à la liberté de choix. Un être vivant peu libre (par exemple un animal qui agit par automatisme) aura une conscience limitée, presque endormie. À l’inverse, plus un être est capable de poser des choix créatifs et imprévus, plus sa conscience s’intensifie. La conscience est donc proportionnelle au degré de spontanéité et de créativité de la vie. C’est pourquoi elle « s’exalte » dans l’activité inventive et « s’éteint » dans la routine mécanique. Elle n’est pas une abstraction immobile, mais une énergie variable, liée à l’élan vital.\nEdmund Husserl, fondateur de la phénoménologie, propose une approche différente. Il refuse de concevoir la conscience comme une chose ou une substance indépendante. Son concept central est celui d’intentionnalité : toute conscience est conscience de quelque chose. Cela signifie que la conscience est toujours tournée vers un objet, réel ou imaginaire, présent ou possible. Elle n’est pas enfermée en elle-même, mais constitue un espace d’ouverture vers le monde. Cette conception permet de comprendre comment les phénomènes apparaissent à nous, chacun selon un certain mode (perception réelle, souvenir, anticipation, imagination). Le rôle de la conscience n’est donc pas de posséder une identité fixe, mais de donner sens et de rendre possible l’expérience.\nEnfin, Jean-Paul Sartre, héritier et critique de Husserl, va encore plus loin. Pour lui, la conscience est avant tout un rapport à l’être. Elle ne se définit pas par accumulation de savoir, mais par le fait qu’elle est toujours en décalage avec elle-même : jamais figée, jamais coïncidente. Sartre parle du pour-soi, une conscience qui existe en se projetant au-delà de ce qu’elle est déjà. Cette distance fait d’elle une liberté, car elle peut se redéfinir à chaque instant. Mais cette liberté est également un risque : la conscience peut fuir cette responsabilité en se mentant à elle-même, par exemple en prétendant que nos choix sont imposés par les circonstances. Sartre appelle cela la mauvaise foi. La conscience est donc inséparablement liberté et fragilité, ouverture et possibilité d’auto-illusion. \n \n MATERIALITE CONSCIENCE\nDepuis Descartes, la philosophie et les sciences de l’esprit se heurtent à une énigme centrale : comment la conscience, immatérielle, subjective et qualitative, peut-elle surgir d’un corps matériel et quantifiable, en particulier du cerveau ? L’expérience vécue — douleur, fatigue, effort, joie — témoigne à la fois de leur étroite interdépendance et de leur différence de nature. Ce problème s’inscrit dans une tradition ancienne : le platonisme et le christianisme avaient déjà introduit une conception dualiste, opposant l’âme immatérielle au corps périssable. Descartes reprend ce dualisme sous la forme de deux substances distinctes, la res cogitans (pensante) et la res extensa (étendue), unies mystérieusement. Mais sa théorie échoue à expliquer l’interaction effective entre ces deux ordres. Pour pallier cette difficulté, certains de ses successeurs inventent des solutions métaphysiques : Malebranche avec l’« occasionnalisme » (Dieu assure à chaque instant la correspondance entre les deux substances), et Leibniz avec l’« harmonie préétablie » (les monades évoluent parallèlement, sans interaction réelle). Spinoza rompt avec ce schéma : il refuse le dualisme et affirme qu’il n’existe qu’une seule substance, que l’on peut saisir sous deux attributs, pensée et étendue. C’est ce qu’on appelle plus tard la théorie du « double aspect » : le mental et le physique ne sont pas deux réalités distinctes, mais deux manières de décrire un même ordre.\nLes conceptions modernes, souvent matérialistes, déplacent le problème. Le cerveau est reconnu comme le siège des phénomènes mentaux, mais reste à comprendre comment l’activité locale de milliards de neurones peut donner lieu à une unité subjective, continue et qualitative — le fameux « problème corps-esprit ». Le matérialisme réductionniste tente de ramener la conscience à la chimie cérébrale, mais se heurte à l’« irréductibilité » de l’expérience vécue : par exemple, la souffrance ne se réduit pas au seul influx nerveux, elle possède une dimension phénoménale singulière. L’émergentisme soutient que la conscience est une propriété nouvelle, émergente de la complexité du cerveau, mais qui ne se laisse pas réduire aux mécanismes élémentaires. Enfin, le fonctionnalisme propose une voie médiane : il reste matérialiste, mais non réductionniste. Selon lui, les états mentaux doivent être définis par leur rôle (par exemple, percevoir, mémoriser, décider) et non par leur seul substrat matériel. La conscience devient alors un niveau fonctionnel d’organisation : inséparable du cerveau, mais irréductible à la matière brute, comme le logiciel par rapport au matériel informatique.", 
  },
    { x: 430, y: 542, img: "Biblio/Adorno Theodor.jpg", type: "info", 
    label:"Adorno Theodor",
    contentImg:"Adorno Theodor",
    contentText:"Adorno dans la dialectique de la raison introduit le terme d’industrie culturelle pour désigner la production de masse de biens culturels. Ce n’est pas une simple extension de la culture populaire : c’est une rationalisation capitaliste de la culture, soumise aux logiques de la production en série et du profit. La culture devient un système uniforme, planifié, qui impose partout les mêmes modèles et réduit la diversité au nom de l’efficacité économique  /n /n L’industrie culturelle fonctionne selon des schémas fixes : mêmes intrigues au cinéma, mêmes stéréotypes dans la musique, mêmes recettes dans la littérature de masse. Ce qui est présenté comme « nouveau » n’est en réalité qu’une variation d’un produit déjà connu. Cela garantit que rien d’imprévu ou de subversif ne puisse émerger. La nouveauté devient un slogan publicitaire, pas une réalité artistique /n /n La consommation de masse n’éveille plus l’imagination, elle la paralyse. Le spectateur doit suivre la succession rapide d’images et de sons sans pouvoir ajouter de sens personnel. Le loisir devient une extension du travail : on se « détend » pour mieux retourner à l’usine le lendemain. L’amusement n’est pas une libération mais une forme de résignation organisée : on consomme ce qui est proposé et on se contente de l’illusion de liberté /n /n Le produit culturel promet un plaisir qu’il ne délivre jamais réellement : il entretient un désir frustré (par exemple avec le cinéma érotique où tout est suggéré mais rien montré). La publicité devient le moteur de l’industrie culturelle, et le consommateur participe par peur de « manquer quelque chose ». Ce mécanisme prépare les masses à accepter des formes de manipulation politique, comme dans le fascisme",
    }
];

const PLAYER_SPEED = 600;
const CLICK_RADIUS = 50;
const DETECTION_RADIUS = 60;

/* ========================== */
let state = {
  mapObj: null,
  player: { x: 100, y: 100 },
  keys: {},
  lastTs: null,
  dragging: false
};

/* DOM elements */
const viewport = document.getElementById('viewport');
const mapEl = document.getElementById('map');
const playerEl = document.getElementById('player');
const posEl = document.getElementById('pos');
const mapNameEl = document.getElementById('mapName');
const locLabelEl = document.getElementById('locLabel');
const modal = document.getElementById('modal');
const modalImg = document.getElementById('modalImg');
const modalText = document.getElementById('modalText');

/* Charger une map */
function loadMap(mapIdOrObj){
  const mapObj = (typeof mapIdOrObj === 'string') ? MAPS[mapIdOrObj] : mapIdOrObj;
  if(!mapObj){ console.error("Map introuvable :", mapIdOrObj); return; }

  state.mapObj = mapObj;
  mapEl.style.width = mapObj.width + "px";
  mapEl.style.height = mapObj.height + "px";
  mapEl.style.backgroundImage = `url("${mapObj.bg}")`;
  mapEl.style.backgroundSize = "cover";
  mapEl.style.backgroundPosition = "center center"; // <-- ajout important

  mapNameEl.textContent = mapObj.name || mapObj.id || "";

  // Attendre que l’image soit bien chargée avant de centrer
  const img = new Image();
  img.onload = () => {
    renderMarkers();
    clampPlayer();
    centerOnPlayer();
  };
  img.src = mapObj.bg;
}

/* Initialisation */
function init(){
  loadMap(CURRENT_MAP_ID);
  // Placer le joueur au centre logique de la map
  state.player.x = MAPS[CURRENT_MAP_ID].width / 2;
  state.player.y = MAPS[CURRENT_MAP_ID].height / 2;

  // Centrage après rendu complet
  window.addEventListener("load", () => {
    centerOnPlayer();
    updateHUD();
    requestAnimationFrame(loop);
  });
}

/* Rendu des marqueurs */
function renderMarkers(){
  mapEl.querySelectorAll('.marker').forEach(n => n.remove());
  LOCATIONS.forEach((loc, idx) => {
    const i = document.createElement('img');
    i.src = loc.img;
    i.className = 'marker';
    i.style.left = loc.x + 'px';
    i.style.top = loc.y + 'px';
    // Appliquer une taille personnalisée si définie dans l'objet LOCATIONS
if (loc.size) {
  i.style.width = loc.size + "px";
  i.style.height = "auto";
} else {
  i.style.width = "50px";
  i.style.height = "auto";
}
i.style.objectFit = "contain"; // évite les déformations

    i.alt = loc.label || ("loc"+idx);
    i.dataset.idx = idx;
    i.addEventListener('click', (ev) => {
      ev.stopPropagation();
      handleLocationClick(loc);
    });
    i.addEventListener('mouseenter', () => locLabelEl.textContent = loc.label);
    i.addEventListener('mouseleave', () => locLabelEl.textContent = "");
    mapEl.appendChild(i);
  });
}

/* Action selon le type */
function handleLocationClick(loc){
  if(!loc) return;
  switch(loc.type){
    case 'info':
      showModal(loc.contentImg, loc.contentText);
      break;
    case 'map':
      if(MAPS[loc.link]) loadMap(loc.link);
      else if (loc.link.endsWith('.html')) window.location.href = loc.link;
      break;
    default:
      console.warn("Type non géré:", loc.type);
  }
}

/* Affichage du modal */
function showModal(imgSrc, text){
  modal.style.display = 'flex';
  modalImg.src = imgSrc || '';
  modalText.innerHTML = formatText(text || '');
}

/* Masquer le modal */
function hideModal(){
  modal.style.display = 'none';
  modalImg.src = '';
  modalText.textContent = '';
}

/* Formater le texte : \n = <br>, \n\n = <br><br> */
function formatText(str){
  return str
    .replace(/\n\s*\n/g, '<br><br>')
    .replace(/\\n/g, '<br>');
}

/* Centrage sur le joueur */
function centerOnPlayer(){
  const vpW = viewport.clientWidth;
  const vpH = viewport.clientHeight;
  const mapW = mapEl.clientWidth;
  const mapH = mapEl.clientHeight;
  let offsetX = vpW/2 - state.player.x;
  let offsetY = vpH/2 - state.player.y;
  offsetX = Math.min(0, Math.max(vpW - mapW, offsetX));
  offsetY = Math.min(0, Math.max(vpH - mapH, offsetY));
  mapEl.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
  playerEl.style.left = state.player.x + 'px';
  playerEl.style.top = state.player.y + 'px';
}

/* Limiter les coordonnées */
function clampPlayer(){
  if(!state.mapObj) return;
  state.player.x = Math.max(0, Math.min(state.mapObj.width, state.player.x));
  state.player.y = Math.max(0, Math.min(state.mapObj.height, state.player.y));
}

/* Déplacement clavier */
window.addEventListener('keydown', (e)=> state.keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup', (e)=> state.keys[e.key.toLowerCase()] = false);

/* Drag */
let dragOffset = {x:0,y:0};
playerEl.addEventListener('pointerdown', (ev)=>{
  ev.preventDefault();
  playerEl.setPointerCapture(ev.pointerId);
  state.dragging = true;
  dragOffset.x = ev.clientX;
  dragOffset.y = ev.clientY;
});
playerEl.addEventListener('pointermove', (ev)=>{
  if(!state.dragging) return;
  const dx = ev.clientX - dragOffset.x;
  const dy = ev.clientY - dragOffset.y;
  state.player.x += dx;
  state.player.y += dy;
  dragOffset.x = ev.clientX;
  dragOffset.y = ev.clientY;
  clampPlayer();
  centerOnPlayer();
  updateHUD();
});
playerEl.addEventListener('pointerup', (ev)=>{
  state.dragging = false;
  try{ playerEl.releasePointerCapture(ev.pointerId);}catch(e){}
});

/* HUD dynamique */
function updateHUD(){
  posEl.textContent = `x:${Math.round(state.player.x)} y:${Math.round(state.player.y)}`;
  let nearest = null, bestDist = Infinity;
  LOCATIONS.forEach(loc => {
    const d = Math.hypot(state.player.x - loc.x, state.player.y - loc.y);
    if (d < bestDist) { bestDist = d; nearest = loc; }
  });
  locLabelEl.textContent = (nearest && bestDist < DETECTION_RADIUS) ? nearest.label : "";
}

/* Boucle principale */
function loop(ts){
  if(!state.lastTs) state.lastTs = ts;
  const dt = (ts - state.lastTs) / 1000;
  state.lastTs = ts;
  let dx = 0, dy = 0;
  if(state.keys['arrowup'] || state.keys['w']) dy -= 1;
  if(state.keys['arrowdown'] || state.keys['s']) dy += 1;
  if(state.keys['arrowleft'] || state.keys['a']) dx -= 1;
  if(state.keys['arrowright'] || state.keys['d']) dx += 1;
  if(dx || dy){
    const len = Math.hypot(dx,dy) || 1;
    state.player.x += (dx/len) * PLAYER_SPEED * dt;
    state.player.y += (dy/len) * PLAYER_SPEED * dt;
    clampPlayer();
    centerOnPlayer();
    updateHUD();
  } else updateHUD();
  requestAnimationFrame(loop);
}

/* Initialisation */
function init(){
  loadMap(CURRENT_MAP_ID);
  // On centre le joueur au milieu de la carte
  state.player.x = state.mapObj.width / 2;
  state.player.y = state.mapObj.height / 2;

  // On attend que la map soit bien rendue avant de centrer
  requestAnimationFrame(() => {
    centerOnPlayer();
    updateHUD();
    requestAnimationFrame(loop);
  });
}

init();
</script>
</body>
</html>
