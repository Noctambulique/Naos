<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Map interactive â€” dÃ©place le curseur</title>
<style>
  :root{
    --ui-bg: rgba(0,0,0,0.6);
    --ui-color: #fff;
    --player-size: 36px;
    --marker-size: 90px;
  }
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;}
  #app{height:100vh;display:flex;flex-direction:column;}
  #hud{
    position:fixed; left:10px; top:10px; z-index:30;
    background:var(--ui-bg); color:var(--ui-color); padding:8px 12px;border-radius:8px;
    font-size:14px; box-shadow:0 4px 12px rgba(0,0,0,.4);
    user-select:none;
  }
  #hud b{display:inline-block; min-width:80px;}
  #viewport{
    position:relative; flex:1; overflow:hidden; background:#222;
  }
  #map{
    position:absolute; left:0; top:0;
    transform-origin:0 0;
  }
  #player{
    position:absolute;
    width:var(--player-size); height:var(--player-size);
    margin-left: calc(var(--player-size) / -2);
    margin-top: calc(var(--player-size) / -2);
    z-index:40;
    cursor:grab;
    transition: transform .03s linear;
  }
  #player:active{cursor:grabbing;}
  .marker{
    position:absolute;
    width:var(--marker-size); height:var(--marker-size);
    margin-left: calc(var(--marker-size) / -2);
    margin-top: calc(var(--marker-size) / -2);
    z-index:35;
    pointer-events:auto;
    user-select:none;
  }
  #modal{
    display:none; position:fixed; inset:0; z-index:100; background: rgba(0,0,0,.7);
    align-items:center; justify-content:center; padding:20px;
  }
  #modal img{max-width:90vw; max-height:90vh; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,.6);}
  #tips{
    position:fixed; right:10px; top:10px; z-index:30;
    background:var(--ui-bg); color:var(--ui-color); padding:8px 12px;border-radius:8px;
    font-size:13px; max-width:220px;
  }
  @media (max-width:600px){
    #hud {font-size:12px}
    :root{--player-size:28px; --marker-size:28px;}
  }
</style>
</head>
<body>
<div id="app">
  <div id="hud">
    <div><b>Position</b> <span id="pos">x:0, y:0</span></div>
    <div style="margin-top:6px"><b>Map</b> <span id="mapName"></span></div>
    <div style="margin-top:6px"><b>Lieu</b> <span id="locLabel"></span></div>
  </div>

  <div id="viewport">
    <div id="map">
      <img id="player" src="data:image/svg+xml;utf8,
        <svg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 24 24' fill='none' stroke='%23ffcc00' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='10' r='3.2' /><path d='M12 2v3M12 21v-3M20 12h-3M7 12H4M17.5 6.5L15.5 8.5M8.5 15.5L6.5 17.5M17.5 17.5L15.5 15.5M8.5 8.5L6.5 6.5' /></svg>" alt="player" draggable="false">
    </div>
  </div>

  <div id="modal" onclick="hideModal()"><img id="modalImg" src="" alt="preview"></div>
</div>

<script>
/* ==========================
   CONFIGURATION
   ========================== */
const MAPS = {
  "ville-centre": {
    id: "ville-centre",
    name: "Ville - Centre",
    bg: "Map/20251017_1201_Carte Graphique StylisÃ©e_remix_01k7rss90xfqt8cz7ymn108g2a (1) (2).png",
    width: 2000,
    height: 2000
  }
};

// Map de dÃ©part
let CURRENT_MAP_ID = "ville-centre";

let LOCATIONS = [
  { x: 700, y: 1070, img: "Map/QGPhilosophe.png", type: "map", link: "map3.html", label:"Philo-map, 9 de carreau" },
  { x: 643, y: 376, img: "Map/MusÃ©e.png", type: "map", link: "Document/Bio CroisÃ© Octavie Basile.odt", label:"Biographie, Roi de Coeur" },
  { x: 928, y: 1100, img: "Map/MÃ©diathÃ¨que.png", type: "document", link: "Document/Film Art Jeu.pdf", label:"Culture, Dame de Coeur" },
  { x: 1222, y: 960, img: "Map/CentredesLubies.png", type: "document", link: "Document/Lubies.pdf", label:"Lubies, Valet de Coeur" },
  { x: 772, y: 866, img: "Map/Mediatheque.png", type: "document", link: "Document/Excel Art.xlsx", label:"Excel Culture, 9 de Coeur" },
  { x: 1248, y: 370, img: "Map/Magasin de jouet.png", type: "document", link: "Document/Objet.png", label:"Artefact, 8 de Coeur" },
  { x: 330, y: 719, img: "Map/Maison1", type: "document", link: "Document/Visuel.png", label:"Visuel, 4 de Coeur" },
  { x: 984, y: 479, img: "Map/MusÃ©eDesSonges.png", type: "document", link: "Document/NaosIndex.png", label:"Naos, Roi de TrÃ¨fle" },
  { x: 1295, y: 590, img: "Map/Maison3.png", type: "document", label:"ACCES BLOQUE : PNG, Dame de TrÃ¨fle" },
  { x: 1295, y: 590, img: "Map/Maison3.png", type: "document", link: "Document/Gens.png", label:"Gens, Valet de TrÃ¨fle" },
  { x: 1382, y: 822, img: "Map/Maison4.png", type: "document", label:"Secret, 10 de TrÃ¨fle" },
  { x: 1030, y: 385, img: "Map/Maison2.png", type: "document", link: "Map/Capture d'Ã©cran 2025-10-17 115259.png", label:"Culture Index, 9 de TrÃ¨fle" },
  { x: 1013, y: 215, img: "Map/Agence de Voyage.png", type: "document", link: "Document/Pays.xlsx", label:"Voyage, 3 de TrÃ¨fle" },
  { x: 517, y: 492, img: "Map/Games.png", type: "document", link: "Document/Jeu.png", label:"Jeu, 2 de TrÃ¨fle" },
  { x: 1421, y: 676, img: "Map/Maison1.png", type: "document", link: "Document/Police.txt", label:"Police, 1 de TrÃ¨fle" },
  { x: 743, y: 558, img: "Map/Mediatheque2.png", type: "document", link: "Document/Book.docx", label:"Book, Roi de Pique" },
  { x: 1080, y: 1054, img: "Map/BureauDuDetective.png", type: "document", link: "Document/Power Point Ultime +.pdf", label:"Triade, Dame de Pique" },
  { x: 1554, y: 875, img: "Map/Statue de glace.png", type: "document", link: "Document/Iceberg.png", label:"Iceberg, Valet de Pique" }
];

const PLAYER_SPEED = 800;
const CLICK_RADIUS = 40;
const DETECTION_RADIUS = 60; // distance Ã  laquelle le label apparaÃ®t

/* ========================== */
let state = {
  mapObj: null,
  player: { x: 100, y: 100 },
  keys: {},
  lastTs: null,
  dragging: false
};

/* DOM elements */
const viewport = document.getElementById('viewport');
const mapEl = document.getElementById('map');
const playerEl = document.getElementById('player');
const posEl = document.getElementById('pos');
const mapNameEl = document.getElementById('mapName');
const locLabelEl = document.getElementById('locLabel');
const modal = document.getElementById('modal');
const modalImg = document.getElementById('modalImg');

/* Charger une map */
function loadMap(mapIdOrObj){
  const mapObj = (typeof mapIdOrObj === 'string') ? MAPS[mapIdOrObj] : mapIdOrObj;
  if(!mapObj){
    console.error("Map introuvable :", mapIdOrObj);
    return;
  }
  state.mapObj = mapObj;
  mapEl.style.width = mapObj.width + "px";
  mapEl.style.height = mapObj.height + "px";
  mapEl.style.backgroundImage = `url("${mapObj.bg}")`;
  mapEl.style.backgroundSize = "cover";
  mapNameEl.textContent = mapObj.name || mapObj.id || "";
  renderMarkers();
  clampPlayer();
  centerOnPlayer();
}

/* Rendu des marqueurs */
function renderMarkers(){
  const old = mapEl.querySelectorAll('.marker');
  old.forEach(n => n.remove());
  LOCATIONS.forEach((loc, idx) => {
    const i = document.createElement('img');
    i.src = loc.img;
    i.className = 'marker';
    i.style.left = loc.x + 'px';
    i.style.top = loc.y + 'px';
    i.alt = loc.label || ("loc"+idx);
    i.dataset.idx = idx;
    i.addEventListener('click', (ev) => {
      ev.stopPropagation();
      handleLocationClick(loc);
    });
    // ðŸ”¹ Affiche le label au survol
    i.addEventListener('mouseenter', () => locLabelEl.textContent = loc.label);
    i.addEventListener('mouseleave', () => locLabelEl.textContent = "");
    mapEl.appendChild(i);
  });
}

/* Click sur la map */
function handleMapClick(clientX, clientY){
  const mapRect = mapEl.getBoundingClientRect();
  const mx = (clientX - mapRect.left);
  const my = (clientY - mapRect.top);
  let best = null; let bestDist = Infinity;
  LOCATIONS.forEach(loc => {
    const d = Math.hypot(mx - loc.x, my - loc.y);
    if(d < bestDist){ bestDist = d; best = loc; }
  });
  if(best && bestDist <= CLICK_RADIUS){
    handleLocationClick(best);
  }
}

/* Action selon le type */
function handleLocationClick(loc){
  if(!loc) return;
  switch(loc.type){
    case 'image':
      showModal(loc.link);
      break;
    case 'document':
    case 'external':
      window.open(loc.link, '_blank');
      break;
    case 'map':
      if(MAPS[loc.link]) {
        loadMap(loc.link);
      } else if (loc.link.endsWith('.html')) {
        window.location.href = loc.link;
      } else {
        console.warn("Map cible introuvable :", loc.link);
      }
      break;
    default:
      console.warn("Type non gÃ©rÃ©:", loc.type);
  }
}

/* Modal */
function showModal(url){ modalImg.src = url; modal.style.display = 'flex'; }
function hideModal(){ modal.style.display = 'none'; modalImg.src = ''; }

/* Centrage */
function centerOnPlayer(){
  const vpW = viewport.clientWidth;
  const vpH = viewport.clientHeight;
  const mapW = mapEl.clientWidth;
  const mapH = mapEl.clientHeight;
  let offsetX = vpW/2 - state.player.x;
  let offsetY = vpH/2 - state.player.y;
  offsetX = Math.min(0, Math.max(vpW - mapW, offsetX));
  offsetY = Math.min(0, Math.max(vpH - mapH, offsetY));
  mapEl.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
  playerEl.style.left = state.player.x + 'px';
  playerEl.style.top = state.player.y + 'px';
}

/* Limiter le joueur */
function clampPlayer(){
  if(!state.mapObj) return;
  state.player.x = Math.max(0, Math.min(state.mapObj.width, state.player.x));
  state.player.y = Math.max(0, Math.min(state.mapObj.height, state.player.y));
}

/* DÃ©placement clavier */
window.addEventListener('keydown', (e)=> state.keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup', (e)=> state.keys[e.key.toLowerCase()] = false);

/* Drag */
let dragOffset = {x:0,y:0};
playerEl.addEventListener('pointerdown', (ev)=>{
  ev.preventDefault();
  playerEl.setPointerCapture(ev.pointerId);
  state.dragging = true;
  dragOffset.x = ev.clientX;
  dragOffset.y = ev.clientY;
});
playerEl.addEventListener('pointermove', (ev)=>{
  if(!state.dragging) return;
  const dx = ev.clientX - dragOffset.x;
  const dy = ev.clientY - dragOffset.y;
  state.player.x += dx;
  state.player.y += dy;
  dragOffset.x = ev.clientX;
  dragOffset.y = ev.clientY;
  clampPlayer();
  centerOnPlayer();
  updateHUD();
});
playerEl.addEventListener('pointerup', (ev)=>{
  state.dragging = false;
  try{ playerEl.releasePointerCapture(ev.pointerId);}catch(e){}
});

mapEl.addEventListener('click', (ev)=> handleMapClick(ev.clientX, ev.clientY));

/* Boucle principale */
function loop(ts){
  if(!state.lastTs) state.lastTs = ts;
  const dt = (ts - state.lastTs) / 1000;
  state.lastTs = ts;
  let dx = 0, dy = 0;
  if(state.keys['arrowup'] || state.keys['w']) dy -= 1;
  if(state.keys['arrowdown'] || state.keys['s']) dy += 1;
  if(state.keys['arrowleft'] || state.keys['a']) dx -= 1;
  if(state.keys['arrowright'] || state.keys['d']) dx += 1;
  if(dx || dy){
    const len = Math.hypot(dx,dy) || 1;
    state.player.x += (dx/len) * PLAYER_SPEED * dt;
    state.player.y += (dy/len) * PLAYER_SPEED * dt;
    clampPlayer();
    centerOnPlayer();
    updateHUD();
  } else {
    // mÃªme sans dÃ©placement, le label doit suivre la position
    updateHUD();
  }
  requestAnimationFrame(loop);
}

/* HUD dynamique */
function updateHUD(){
  posEl.textContent = `x:${Math.round(state.player.x)} y:${Math.round(state.player.y)}`;
  
  // Trouver le lieu le plus proche
  let nearest = null;
  let bestDist = Infinity;
  LOCATIONS.forEach(loc => {
    const d = Math.hypot(state.player.x - loc.x, state.player.y - loc.y);
    if (d < bestDist) {
      bestDist = d;
      nearest = loc;
    }
  });

  // Affichage du label si assez proche
  if (nearest && bestDist < DETECTION_RADIUS) {
    locLabelEl.textContent = nearest.label;
  } else if (!state.dragging) {
    // On efface seulement si le joueur ne traÃ®ne pas un marker
    locLabelEl.textContent = "";
  }
}

/* Initialisation */
function init(){
  loadMap(CURRENT_MAP_ID);
  state.player.x = state.mapObj.width/2;
  state.player.y = state.mapObj.height/2;
  centerOnPlayer();
  updateHUD();
  requestAnimationFrame(loop);
}
init();
</script>
</body>
</html>
