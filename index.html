<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Map interactive â€” dÃ©place le curseur</title>
<style>
  :root{
    --ui-bg: rgba(0,0,0,0.6);
    --ui-color: #fff;
    --player-size: 36px;
    --marker-size: 90px;
  }
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;}
  #app{height:100vh;display:flex;flex-direction:column;}
  #hud{
    position:fixed; left:10px; top:10px; z-index:30;
    background:var(--ui-bg); color:var(--ui-color); padding:8px 12px;border-radius:8px;
    font-size:14px; box-shadow:0 4px 12px rgba(0,0,0,.4);
    user-select:none;
  }
  #hud b{display:inline-block; min-width:80px;}
  #viewport{
    position:relative; flex:1; overflow:hidden; background:#222;
  }
  #map{
    position:absolute; left:0; top:0;
    transform-origin:0 0;
  }
#player{
  position:absolute;
  width:var(--player-size); height:var(--player-size);
  margin-left: calc(var(--player-size) / -2);
  margin-top: calc(var(--player-size) / -2);
  z-index:40;
  cursor:grab;
  transition: transform .03s linear;
  display:none; /* ðŸ‘ˆ ajoutÃ© : le curseur est cachÃ© au dÃ©part */
  }
  #player:active{cursor:grabbing;}
.marker{
  position:absolute;
  width:var(--marker-size); 
  height:var(--marker-size);
  margin-left: calc(var(--marker-size) / -2);
  margin-top: calc(var(--marker-size) / -2);
  z-index:35;
  pointer-events:auto;
  user-select:none;
  object-fit: contain; /* âœ… Ajout important : garde le format original de lâ€™image */
}
  #modal{
    display:none; position:fixed; inset:0; z-index:100; background: rgba(0,0,0,.7);
    align-items:center; justify-content:center; padding:20px;
  }
  #modal img{max-width:90vw; max-height:90vh; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,.6);}
  #tips{
    position:fixed; right:10px; top:10px; z-index:30;
    background:var(--ui-bg); color:var(--ui-color); padding:8px 12px;border-radius:8px;
    font-size:13px; max-width:220px;
  }
  @media (max-width:600px){
    #hud {font-size:12px}
    :root{--player-size:28px; --marker-size:28px;}
  }
</style>
</head>
<body>
<div id="app">
  <div id="hud">
    <div><b>Position</b> <span id="pos">x:0, y:0</span></div>
    <div style="margin-top:6px"><b>Map</b> <span id="mapName"></span></div>
    <div style="margin-top:6px"><b>Lieu</b> <span id="locLabel"></span></div>
  </div>

  <div id="viewport">
    <div id="map">
      <img id="player" src="data:image/svg+xml;utf8,
        <svg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 24 24' fill='none' stroke='%23ffcc00' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='10' r='3.2' /><path d='M12 2v3M12 21v-3M20 12h-3M7 12H4M17.5 6.5L15.5 8.5M8.5 15.5L6.5 17.5M17.5 17.5L15.5 15.5M8.5 8.5L6.5 6.5' /></svg>" alt="player" draggable="false">
    </div>
  </div>

  <div id="modal" onclick="hideModal()"><img id="modalImg" src="" alt="preview"></div>
</div>

<script>
/* ==========================
   CONFIGURATION
   ========================== */
const MAPS = {
  "ville-centre": {
    id: "ville-centre",
    name: "Ville - Centre",
    bg: "Map/20251024_1225_Carte MystÃ©rieuse Violette_remix_01k8avxhcbetprmp4757n3ah3e (1).png",
    width: 1700,
    height: 1700
  }
};

// Map de dÃ©part
let CURRENT_MAP_ID = "ville-centre";

let LOCATIONS = [
  { x: 630, y: 430, img: "Map/20251023_1358_Ã‰crivain MystÃ©rieux Nocturne_simple_compose_01k88ew9t3ecab4bd5p686bxys.png", type: "map", link: "Anecdotes.html", label:"Anecdotes, Roi de â™¦ï¸", size: 80 },
  { x: 366, y: 814, img: "Philo/Gardien de la Nature.png", type: "map", link: "Histoire de la Philo.html", label:"Histoire Philo, Dame de â™¦ï¸", size: 80 },
  { x: 649, y: 1164, img: "Psy/Psycho.png", type: "map", link: "Psycho.html", label:"Psycho, Valet de â™¦ï¸", size: 70 },
  { x: 721, y: 1046, img: "Map/QGPhilosophe.png", type: "map", link: "Philo.html", label:"Philo-map, 10 de â™¦ï¸" },
  { x: 468, y: 590, img: "Map/Librairie.png", type: "map", link: "Biblio.html", label:"Biblio-Map, 7 de â™¦ï¸" },
  { x: 933, y: 1234, img:"Map/Biographie.png", type: "document", link: "Document/Bio CroisÃ© Octavie Basile.odt", label:"Biographie, Roi de â¤ï¸", size: 120 },
  { x: 1175, y: 1086, img: "Map/Homme au Masque.png", type: "document", link: "Document/Film Art Jeu.pdf", label:"Culture, Dame de â¤ï¸", size: 80 },
  { x: 1013, y: 968, img: "Map/Bric Brac.png", type: "document", link: "Document/Lubies.pdf", label:"Lubies, Valet de â¤ï¸" },
  { x: 513, y: 1290, img: "Map/Avenir.png", type: "document", link: "Document/Avenir.md", label:"Avenir, 10 de â¤ï¸", size: 60 },
  { x: 280, y: 637, img: "Map/CinÃ©ma.png", type: "document", link: "Document/Excel Art.xlsx", label:"Excel Culture, 9 de â¤ï¸" },
  { x: 398, y: 395, img: "Map/Maison1.png", type: "document", link: "Document/Objet.png", label:"Artefact, 8 de â¤ï¸" },
  { x: 746, y: 563, img: "Map/Anecdotes.png", type: "document", link: "Document/Anecdotes.xlsx", label:"Anecdotes, 5 de â¤ï¸" },
  { x: 1183, y: 823, img: "Map/Fleurs.png", type: "document", link: "Document/Plante.odp", label:"Plantes, 5 de â¤ï¸", size: 50 },
  { x: 1095, y: 281, img: "Map/Maison1.png", type: "document", link: "Document/Visuel.png", label:"Visuel, 4 de â¤ï¸" },
  { x: 1177, y: 678, img: "Map/Maison2.png", type: "document", link: "Document/NaosIndex.png", label:"Naos, Roi de â™£ï¸" },
  { x: 1301, y: 696, img: "Map/Maison3.png", type: "document", link: "Document/Capture d'Ã©cran 2025-10-20 004502.png", label:"PNG, Dame de â™£ï¸" },
  { x: 941, y: 629, img: "Map/Statue de glace.png", type: "document", link: "Document/Gens.png", label:"Gens, Valet de â™£ï¸", size: 130 },
  { x: 1329, y: 823, img: "Map/Maison4.png", type: "document", label:"Secret, 10 de â™£ï¸" },
  { x: 981, y: 290, img: "Map/Maison5.png", type: "document", link: "Map/Capture d'Ã©cran 2025-10-17 115259.png", label:"Culture Index, 9 de â™£ï¸" },
  { x: 816, y: 212, img: "Map/Agence de Voyage.png", type: "document", link: "Document/Pays.xlsx", label:"Voyage, 3 de â™£ï¸" },
  { x: 1129, y: 412, img: "Map/Maison2.png", type: "document", link: "Document/Police.txt", label:"Police, 1 de â™£ï¸" },
  { x: 750, y: 830, img: "Map/Tour.png", type: "document", link: "Document/Book.docx", label:"Book, Roi de â™ ï¸", size: 200 },
  { x: 643, y: 289, img: "Map/Triade.png", type: "map", link: "Document/Power Point Ultime +.pdf", label:"Triade, Dame de â™ ï¸", size: 130 },
  { x: 262, y: 1039, img: "Map/Iceberg.png", type: "document", link: "Document/Iceberg.png", label:"Iceberg, Valet de â™ ï¸" },
  { x: 1444, y: 231, img: "Map/20251006_0329_Montagne Blanche Minimaliste_simple_compose_01k6vj5z3wfefb6etw8jav52cb.png", type: "document", link: "Document/Montagne.pdf", label:"Montagne, 5 de â™ ï¸", size: 350 },
  { x: 1335, y: 937, img: "Map/Maison2.png", type: "document", link: "Document/Plan.png", label:"Plan, 1 de â™ ï¸" }
];

const PLAYER_SPEED = 800;
const CLICK_RADIUS = 40;
const DETECTION_RADIUS = 60; // distance Ã  laquelle le label apparaÃ®t

/* ========================== */
let state = {
  mapObj: null,
  player: { x: 100, y: 100 },
  keys: {},
  lastTs: null,
  dragging: false
};

let modeDeplacement = false; // ðŸ‘ˆ au dÃ©part le dÃ©placement est dÃ©sactivÃ©
playerEl.style.display = 'none'; // ðŸ‘ˆ le curseur est cachÃ© au lancement
let modeLabel = false;       // Touche B : affiche texte Ã  la place des icÃ´nes
  
/* DOM elements */
const viewport = document.getElementById('viewport');
const mapEl = document.getElementById('map');
const playerEl = document.getElementById('player');
const posEl = document.getElementById('pos');
const mapNameEl = document.getElementById('mapName');
const locLabelEl = document.getElementById('locLabel');
const modal = document.getElementById('modal');
const modalImg = document.getElementById('modalImg');

/* Charger une map */
function loadMap(mapIdOrObj){
  const mapObj = (typeof mapIdOrObj === 'string') ? MAPS[mapIdOrObj] : mapIdOrObj;
  if(!mapObj){
    console.error("Map introuvable :", mapIdOrObj);
    return;
  }
  state.mapObj = mapObj;
  mapEl.style.width = mapObj.width + "px";
  mapEl.style.height = mapObj.height + "px";
  mapEl.style.backgroundImage = `url("${mapObj.bg}")`;
  mapEl.style.backgroundSize = "cover";
  mapNameEl.textContent = mapObj.name || mapObj.id || "";
  renderMarkers();
  clampPlayer();
  centerOnPlayer();
}

function renderMarkers(){
  // On supprime les anciens marqueurs
  const old = mapEl.querySelectorAll('.marker, .label-marker');
  old.forEach(n => n.remove());

  LOCATIONS.forEach((loc, idx) => {
    let element;

    if(modeLabel) {
      // ðŸ·ï¸ Mode Label : afficher le texte
      element = document.createElement('div');
      element.className = 'label-marker';
      element.textContent = loc.label;
      element.style.position = 'absolute';
      element.style.transform = 'translate(-50%, -50%)';
      element.style.padding = '4px 8px';
      element.style.borderRadius = '6px';
      element.style.background = 'rgba(0,0,0,0.6)';
      element.style.color = 'white';
      element.style.fontSize = '14px';
      element.style.whiteSpace = 'nowrap';
    } else {
      // ðŸ  Mode normal : afficher l'image
      element = document.createElement('img');
      element.src = loc.img;
      element.className = 'marker';
      const size = loc.size || getComputedStyle(document.documentElement).getPropertyValue('--marker-size');
      element.style.width = size + 'px';
      element.style.height = size + 'px';
      element.style.marginLeft = `calc(${size}px / -2)`;
      element.style.marginTop = `calc(${size}px / -2)`;
      element.style.objectFit = 'contain';
    }

    // Positionnement
    element.style.left = loc.x + 'px';
    element.style.top = loc.y + 'px';
    element.dataset.idx = idx;

    // Interaction
    element.addEventListener('click', ev => {
      ev.stopPropagation();
      handleLocationClick(loc);
    });
    element.addEventListener('mouseenter', () => locLabelEl.textContent = loc.label);
    element.addEventListener('mouseleave', () => locLabelEl.textContent = "");

    mapEl.appendChild(element);
  });
}

/* Click sur la map */
function handleMapClick(clientX, clientY){
  const mapRect = mapEl.getBoundingClientRect();
  const mx = (clientX - mapRect.left);
  const my = (clientY - mapRect.top);
  let best = null; let bestDist = Infinity;
  LOCATIONS.forEach(loc => {
    const d = Math.hypot(mx - loc.x, my - loc.y);
    if(d < bestDist){ bestDist = d; best = loc; }
  });
  if(best && bestDist <= CLICK_RADIUS){
    handleLocationClick(best);
  }
}

/* Action selon le type */
function handleLocationClick(loc){
  if(!loc) return;
  switch(loc.type){
    case 'image':
      showModal(loc.link);
      break;
    case 'document':
    case 'external':
      window.open(loc.link, '_blank');
      break;
    case 'map':
      if(MAPS[loc.link]) {
        loadMap(loc.link);
      } else if (loc.link.endsWith('.html')) {
        window.location.href = loc.link;
      } else {
        console.warn("Map cible introuvable :", loc.link);
      }
      break;
    default:
      console.warn("Type non gÃ©rÃ©:", loc.type);
  }
}

/* Modal */
function showModal(url){ modalImg.src = url; modal.style.display = 'flex'; }
function hideModal(){ modal.style.display = 'none'; modalImg.src = ''; }

/* Centrage */
function centerOnPlayer(){
  const vpW = viewport.clientWidth;
  const vpH = viewport.clientHeight;
  const mapW = mapEl.clientWidth;
  const mapH = mapEl.clientHeight;
  let offsetX = vpW/2 - state.player.x;
  let offsetY = vpH/2 - state.player.y;
  offsetX = Math.min(0, Math.max(vpW - mapW, offsetX));
  offsetY = Math.min(0, Math.max(vpH - mapH, offsetY));
  mapEl.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
  playerEl.style.left = state.player.x + 'px';
  playerEl.style.top = state.player.y + 'px';
}

/* Limiter le joueur */
function clampPlayer(){
  if(!state.mapObj) return;
  state.player.x = Math.max(0, Math.min(state.mapObj.width, state.player.x));
  state.player.y = Math.max(0, Math.min(state.mapObj.height, state.player.y));
}

/* DÃ©placement clavier */
window.addEventListener('keydown', (e) => {
  const key = e.key.toLowerCase();

  // ðŸ”„ Toggle mode dÃ©placement
if (key === 'a') {
  modeDeplacement = !modeDeplacement;
  console.log("Mode dÃ©placement :", modeDeplacement);

  // ðŸ‘‡ Ajout : afficher / cacher le curseur
  playerEl.style.display = modeDeplacement ? 'block' : 'none';

  return; // On stoppe ici pour ne pas activer une touche de dÃ©placement
}

  // ðŸ”„ Toggle mode affichage des labels
  if (key === 'b') {
    modeLabel = !modeLabel;
    renderMarkers();
    console.log("Mode labels :", modeLabel);
    return;
  }

  // âœ… Activer les touches de dÃ©placement uniquement si le mode est actif
  if (modeDeplacement) {
    state.keys[key] = true;
  }
});

window.addEventListener('keyup', (e) => {
  const key = e.key.toLowerCase();
  state.keys[key] = false;
});

/* Drag */
let dragOffset = {x:0,y:0};
playerEl.addEventListener('pointerdown', (ev)=>{
  ev.preventDefault();
  playerEl.setPointerCapture(ev.pointerId);
  state.dragging = true;
  dragOffset.x = ev.clientX;
  dragOffset.y = ev.clientY;
});
playerEl.addEventListener('pointermove', (ev)=>{
  if(!state.dragging) return;
  const dx = ev.clientX - dragOffset.x;
  const dy = ev.clientY - dragOffset.y;
  state.player.x += dx;
  state.player.y += dy;
  dragOffset.x = ev.clientX;
  dragOffset.y = ev.clientY;
  clampPlayer();
  centerOnPlayer();
  updateHUD();
});
playerEl.addEventListener('pointerup', (ev)=>{
  state.dragging = false;
  try{ playerEl.releasePointerCapture(ev.pointerId);}catch(e){}
});

mapEl.addEventListener('click', (ev)=> handleMapClick(ev.clientX, ev.clientY));

/* Boucle principale */
function loop(ts){
  if(!state.lastTs) state.lastTs = ts;
  const dt = (ts - state.lastTs) / 1000;
  state.lastTs = ts;
  let dx = 0, dy = 0;
  if(state.keys['arrowup'] || state.keys['w']) dy -= 1;
  if(state.keys['arrowdown'] || state.keys['s']) dy += 1;
  if(state.keys['arrowleft'] || state.keys['a']) dx -= 1;
  if(state.keys['arrowright'] || state.keys['d']) dx += 1;

  if(modeDeplacement) {
    // ðŸ‘‰ Curseur visible en mode dÃ©placement

    if(dx || dy){
      const len = Math.hypot(dx,dy) || 1;
      state.player.x += (dx/len) * PLAYER_SPEED * dt;
      state.player.y += (dy/len) * PLAYER_SPEED * dt;
      clampPlayer();
      centerOnPlayer();
    }
  } else {
    // ðŸ‘‡ Curseur cachÃ© en mode exploration libre
  }

  updateHUD();
  requestAnimationFrame(loop);
}

/* HUD dynamique */
function updateHUD(){
  posEl.textContent = `x:${Math.round(state.player.x)} y:${Math.round(state.player.y)}`;
  
  // Trouver le lieu le plus proche
  let nearest = null;
  let bestDist = Infinity;
  LOCATIONS.forEach(loc => {
    const d = Math.hypot(state.player.x - loc.x, state.player.y - loc.y);
    if (d < bestDist) {
      bestDist = d;
      nearest = loc;
    }
  });

  // Affichage du label si assez proche
  if (nearest && bestDist < DETECTION_RADIUS) {
    locLabelEl.textContent = nearest.label;
  } else if (!state.dragging) {
    // On efface seulement si le joueur ne traÃ®ne pas un marker
    locLabelEl.textContent = "";
  }
}

/* Initialisation */
function init(){
  loadMap(CURRENT_MAP_ID);
  state.player.x = state.mapObj.width/2;
  state.player.y = state.mapObj.height/2;
  centerOnPlayer();
  updateHUD();
  requestAnimationFrame(loop);
}
init();
</script>
</body>
</html>
