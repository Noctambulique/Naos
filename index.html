<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Map interactive ‚Äî d√©place le curseur</title>
<style>
  :root{
    --ui-bg: rgba(0,0,0,0.6);
    --ui-color: #fff;
    --player-size: 36px;
    --marker-size: 36px;
  }
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;}
  #app{height:100vh;display:flex;flex-direction:column;}
  #hud{
    position:fixed; left:10px; top:10px; z-index:30;
    background:var(--ui-bg); color:var(--ui-color); padding:8px 12px;border-radius:8px;
    font-size:14px; box-shadow:0 4px 12px rgba(0,0,0,.4);
    user-select:none;
  }
  #hud b{display:inline-block; min-width:80px;}
  #viewport{
    position:relative; flex:1; overflow:hidden; background:#222;
  }
  #map{
    position:absolute; left:0; top:0;
    transform-origin:0 0;
  }
  #player{
    position:absolute;
    width:var(--player-size); height:var(--player-size);
    margin-left: calc(var(--player-size) / -2);
    margin-top: calc(var(--player-size) / -2);
    z-index:40;
    cursor:grab;
    transition: transform .03s linear;
  }
  #player:active{cursor:grabbing;}
  .marker{
    position:absolute;
    width:var(--marker-size); height:var(--marker-size);
    margin-left: calc(var(--marker-size) / -2);
    margin-top: calc(var(--marker-size) / -2);
    z-index:35;
    pointer-events:auto;
    user-select:none;
  }
  #modal{
    display:none; position:fixed; inset:0; z-index:100; background: rgba(0,0,0,.7);
    align-items:center; justify-content:center; padding:20px;
  }
  #modal img{max-width:90vw; max-height:90vh; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,.6);}
  #tips{
    position:fixed; right:10px; top:10px; z-index:30;
    background:var(--ui-bg); color:var(--ui-color); padding:8px 12px;border-radius:8px;
    font-size:13px; max-width:220px;
  }
  @media (max-width:600px){
    #hud {font-size:12px}
    :root{--player-size:28px; --marker-size:28px;}
  }
</style>
</head>
<body>
<div id="app">
  <div id="hud">
    <div><b>Position</b><span id="pos">x:0, y:0</span></div>
    <div style="margin-top:6px"><b>Map</b> <span id="mapName"></span></div>
  </div>

  <div id="tips">
    D√©place le joueur : fl√®ches / WASD ou glisser.<br>
    Clique pr√®s d'un ic√¥ne pour ouvrir (image/doc/map).<br>
    Param√®tre la map et les emplacements dans la section JS "MAPS" / "LOCATIONS".
  </div>

  <div id="viewport">
    <div id="map">
      <img id="player" src="data:image/svg+xml;utf8,
        <svg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 24 24' fill='none' stroke='%23ffcc00' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='10' r='3.2' /><path d='M12 2v3M12 21v-3M20 12h-3M7 12H4M17.5 6.5L15.5 8.5M8.5 15.5L6.5 17.5M17.5 17.5L15.5 15.5M8.5 8.5L6.5 6.5' /></svg>" alt="player" draggable="false">
    </div>
  </div>

  <div id="modal" onclick="hideModal()"><img id="modalImg" src="" alt="preview"></div>
</div>

<script>
/* ==========================
   CONFIGURATION
   ========================== */
const MAPS = {
  "ville-centre": {
    id: "ville-centre",
    name: "Ville - Centre",
    bg: "https://images.unsplash.com/photo-1549880338-65ddcdfd017b?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=09b8022a2b6622c1f2d2d6f7f9b9b9b9",
    width: 2000,
    height: 1200
  }
};

// Map de d√©part
let CURRENT_MAP_ID = "ville-centre";

const LOCATION_TEMPLATES = {
  defaultMarker: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 24 24' fill='none' stroke='%23007acc' stroke-width='1.8' stroke-linecap='round' stroke-linejoin='round'><path d='M12 21s-4.6-4.35-6.5-7.5A6.5 6.5 0 1 1 18.5 13.5C16.6 16.65 12 21 12 21z'/><circle cx='12' cy='10' r='2.5'/></svg>"
};

let LOCATIONS = [
  { x: 500, y: 350, img: LOCATION_TEMPLATES.defaultMarker, type: "map", link: "map2.html", label:"Philo-map" },
  { x: 900, y: 450, img: LOCATION_TEMPLATES.defaultMarker, type: "document", link: "docs/plan-parc.pdf", label:"Plan du parc" },
  { x: 1200, y: 300, img: LOCATION_TEMPLATES.defaultMarker, type: "map", link: "quartier-nord", label:"Quartier Nord" }
];

const PLAYER_SPEED = 300;
const CLICK_RADIUS = 40;

/* ========================== */
let state = {
  mapObj: null,
  player: { x: 100, y: 100 },
  keys: {},
  lastTs: null,
  dragging: false
};

/* DOM elements */
const viewport = document.getElementById('viewport');
const mapEl = document.getElementById('map');
const playerEl = document.getElementById('player');
const posEl = document.getElementById('pos');
const mapNameEl = document.getElementById('mapName');
const modal = document.getElementById('modal');
const modalImg = document.getElementById('modalImg');

/* Charger une map */
function loadMap(mapIdOrObj){
  const mapObj = (typeof mapIdOrObj === 'string') ? MAPS[mapIdOrObj] : mapIdOrObj;
  if(!mapObj){
    console.error("Map introuvable :", mapIdOrObj);
    return;
  }
  state.mapObj = mapObj;
  mapEl.style.width = mapObj.width + "px";
  mapEl.style.height = mapObj.height + "px";
  mapEl.style.backgroundImage = `url("${mapObj.bg}")`;
  mapEl.style.backgroundSize = "cover";
  mapNameEl.textContent = mapObj.name || mapObj.id || "";
  renderMarkers();
  clampPlayer();
  centerOnPlayer();
}

/* Rendu des marqueurs */
function renderMarkers(){
  const old = mapEl.querySelectorAll('.marker');
  old.forEach(n => n.remove());
  LOCATIONS.forEach((loc, idx) => {
    const i = document.createElement('img');
    i.src = loc.img;
    i.className = 'marker';
    i.style.left = loc.x + 'px';
    i.style.top = loc.y + 'px';
    i.alt = loc.label || ("loc"+idx);
    i.dataset.idx = idx;
    i.addEventListener('click', (ev) => {
      ev.stopPropagation();
      handleLocationClick(loc);
    });
    mapEl.appendChild(i);
  });
}

/* Click sur la map */
function handleMapClick(clientX, clientY){
  const mapRect = mapEl.getBoundingClientRect();
  const mx = (clientX - mapRect.left);
  const my = (clientY - mapRect.top);
  let best = null; let bestDist = Infinity;
  LOCATIONS.forEach(loc => {
    const d = Math.hypot(mx - loc.x, my - loc.y);
    if(d < bestDist){ bestDist = d; best = loc; }
  });
  if(best && bestDist <= CLICK_RADIUS){
    handleLocationClick(best);
  }
}

/* Action selon le type */
function handleLocationClick(loc){
  if(!loc) return;
  switch(loc.type){
    case 'image':
      showModal(loc.link);
      break;
    case 'document':
    case 'external':
      window.open(loc.link, '_blank');
      break;
    case 'map':
      if(MAPS[loc.link]) {
        loadMap(loc.link);
      } else if (loc.link.endsWith('.html')) {
        // üî• ouverture d‚Äôun autre fichier de carte
        window.location.href = loc.link;
      } else {
        console.warn("Map cible introuvable :", loc.link);
      }
      break;
    default:
      console.warn("Type non g√©r√©:", loc.type);
  }
}

/* Modal */
function showModal(url){ modalImg.src = url; modal.style.display = 'flex'; }
function hideModal(){ modal.style.display = 'none'; modalImg.src = ''; }

/* Centrage */
function centerOnPlayer(){
  const vpW = viewport.clientWidth;
  const vpH = viewport.clientHeight;
  const mapW = mapEl.clientWidth;
  const mapH = mapEl.clientHeight;
  let offsetX = vpW/2 - state.player.x;
  let offsetY = vpH/2 - state.player.y;
  offsetX = Math.min(0, Math.max(vpW - mapW, offsetX));
  offsetY = Math.min(0, Math.max(vpH - mapH, offsetY));
  mapEl.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
  playerEl.style.left = state.player.x + 'px';
  playerEl.style.top = state.player.y + 'px';
}

/* Limiter le joueur */
function clampPlayer(){
  if(!state.mapObj) return;
  state.player.x = Math.max(0, Math.min(state.mapObj.width, state.player.x));
  state.player.y = Math.max(0, Math.min(state.mapObj.height, state.player.y));
}

/* D√©placement clavier */
window.addEventListener('keydown', (e)=> state.keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup', (e)=> state.keys[e.key.toLowerCase()] = false);

/* Drag */
let dragOffset = {x:0,y:0};
playerEl.addEventListener('pointerdown', (ev)=>{
  ev.preventDefault();
  playerEl.setPointerCapture(ev.pointerId);
  state.dragging = true;
  dragOffset.x = ev.clientX;
  dragOffset.y = ev.clientY;
});
playerEl.addEventListener('pointermove', (ev)=>{
  if(!state.dragging) return;
  const dx = ev.clientX - dragOffset.x;
  const dy = ev.clientY - dragOffset.y;
  state.player.x += dx;
  state.player.y += dy;
  dragOffset.x = ev.clientX;
  dragOffset.y = ev.clientY;
  clampPlayer();
  centerOnPlayer();
  updateHUD();
});
playerEl.addEventListener('pointerup', (ev)=>{
  state.dragging = false;
  try{ playerEl.releasePointerCapture(ev.pointerId);}catch(e){}
});

mapEl.addEventListener('click', (ev)=> handleMapClick(ev.clientX, ev.clientY));

/* Boucle principale */
function loop(ts){
  if(!state.lastTs) state.lastTs = ts;
  const dt = (ts - state.lastTs) / 1000;
  state.lastTs = ts;
  let dx = 0, dy = 0;
  if(state.keys['arrowup'] || state.keys['w']) dy -= 1;
  if(state.keys['arrowdown'] || state.keys['s']) dy += 1;
  if(state.keys['arrowleft'] || state.keys['a']) dx -= 1;
  if(state.keys['arrowright'] || state.keys['d']) dx += 1;
  if(dx || dy){
    const len = Math.hypot(dx,dy) || 1;
    state.player.x += (dx/len) * PLAYER_SPEED * dt;
    state.player.y += (dy/len) * PLAYER_SPEED * dt;
    clampPlayer();
    centerOnPlayer();
    updateHUD();
  }
  requestAnimationFrame(loop);
}

/* HUD */
function updateHUD(){
  posEl.textContent = `x:${Math.round(state.player.x)} y:${Math.round(state.player.y)}`;
}

/* Init */
function init(){
  loadMap(CURRENT_MAP_ID);
  state.player.x = state.mapObj.width/2;
  state.player.y = state.mapObj.height/2;
  centerOnPlayer();
  updateHUD();
  requestAnimationFrame(loop);
}
init();
</script>
</body>
</html>
